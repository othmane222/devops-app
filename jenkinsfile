pipeline {
    agent any 

    tools {
        maven 'maven' 
    }

    environment {
        DOCKER_REGISTRY = 'https://index.docker.io/v1/' 
        DOCKER_IMAGE_NAME = 'othmanemaarad442/devops-app'
        DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'
        SSH_CREDENTIALS_ID = 'services-vm-ssh-key'
        SERVICES_VM_IP = '192.168.252.139' 
        SERVICES_VM_USER = 'services'
    }

    stages {
        stage('1. Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('2. Build & Test') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        // Vous pouvez réactiver cette étape plus tard en ajoutant le plugin Dependency-Check
        
       // stage('3. Security Scan') {
         //   steps {
           //     dependencyCheck additionalArguments: '--scan ./ --format ALL', odcInstallation: 'Default'
             //   dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            //}
        //}
        

        stage('4. Build & Push Docker Image') {
            steps {
                script {
                    // Utilise un tag unique pour l'image, basé sur le numéro de build
                    def imageTag = "v${env.BUILD_NUMBER}"
                    
                    // Construit l'image Docker
                    def dockerImage = docker.build("${env.DOCKER_IMAGE_NAME}:${imageTag}", '.')

                    // Se connecte à Docker Hub en utilisant les credentials stockés
                    docker.withRegistry(env.DOCKER_REGISTRY, env.DOCKER_CREDENTIALS_ID) {
                        // Pousse l'image avec le tag du numéro de build
                        dockerImage.push()

                        // Pousse aussi l'image avec le tag 'latest'
                        dockerImage.push('latest')
                    }
                }
            }
        }
        
        stage('5. Deploy to Production') {
            steps {
                script {
                    // La nouvelle version de l'image que nous venons de pusher
                    def newImageTag = "v${env.BUILD_NUMBER}"
                    
                    // On utilise le plugin SSH Agent avec nos credentials
                    sshagent(credentials: [SSH_CREDENTIALS_ID]) {
                        // Commande SSH pour se connecter à la VM et exécuter le déploiement
                        sh """
                            ssh -o StrictHostKeyChecking=no ${env.SERVICES_VM_USER}@${env.SERVICES_VM_IP} <<- 'EOF'
                            
                            echo "--- Connexion réussie à la VM de services ---"
                            
                            cd ~/app-stack

                            echo "--- Mise à jour de l'image vers ${env.DOCKER_IMAGE_NAME}:${newImageTag} ---"
                            
                            sed -i 's|image: .*|image: ${env.DOCKER_IMAGE_NAME}:${newImageTag}|g' docker-compose.yaml

                            echo "--- Lancement de docker-compose avec la nouvelle image ---"
                            
                            docker-compose down
                            
                            docker-compose up -d

                            echo "--- Déploiement terminé ---"

                            EOF
                        """
                    }
                }
            }
        }
    }
}